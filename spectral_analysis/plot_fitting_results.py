#!/Library/Frameworks/Python.framework/Versions/3.6/bin/python3
# -*- coding: utf-8 -*

# ------------------------------------------------------------------------------
# set some parameters for the analysis manually
# ------------------------------------------------------------------------------
dpi = 200
# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------


def plot_errors_vs_loc(results, path_to_results):
    """
    Plot errors of input and output parameters (S, T, tc) vs the observation
    location in the aquifer (2D transect). This results in three plots per OGS
    model run.

    Parameters
    ----------

    results : pandas dataframe
        Dataframe with results generated by multi_psd.py.

    Yields
    ------

    see docstring description
    """

    import matplotlib.pyplot as plt

    def plot(x, y, path, label):
        plt.plot(x, y, label=label)
        plt.xlabel("Location of pbservation point [m]")
        plt.ylabel("Error in %")
        plt.legend()
        plt.savefig(path, dpi=dpi)
        plt.close()

    for project_folder in results.name.unique():
        err_S = results[results["name"] == project_folder]["err_S"]
        err_T = results[results["name"] == project_folder]["err_T"]
        err_tc = results[results["name"] == project_folder]["err_tc"]
        obs_loc = results[results["name"] == project_folder]["obs_loc"]
        plot(
            obs_loc,
            err_S,
            path_to_results + "/" + project_folder + "_err_S.png",
            label=project_folder,
        )
        plot(
            obs_loc,
            err_T,
            path_to_results + "/" + project_folder + "_err_T.png",
            label=project_folder,
        )
        plot(
            obs_loc,
            err_tc,
            path_to_results + "/" + project_folder + "_err_tc.png",
            label=project_folder,
        )


def plot_heatmap(results, path_to_results):
    """
    Plot errors of input and output parameters (S, T, tc) vs the parameter
    range as heatmap. This results in three plots per location.

    Parameters
    ----------

    results : pandas dataframe
        Dataframe with results generated by multi_psd.py.

    Yields
    ------

    see docstring description
    """

    import seaborn as sns
    import os

    def plot(pivotted, error):
        plot = sns.heatmap(pivotted, cmap="RdBu")
        fig = plot.get_figure()
        if not os.path.exists(path_to_results + "/heatmap"):
            os.mkdir(path_to_results + "/heatmap")
        fig.savefig(
            path_to_results + "/heatmap" + "/" + str(obs_loc) + "_" + error,
            dpi=dpi,
        )
        fig.clf()

    for obs_loc in results["obs_loc"]:
        # extract only rows with obs_loc==obs_loc
        df_obs_loc = results[results.obs_loc == obs_loc]
        # extract columns for plotting
        for error in ["err_S", "err_T", "err_tc"]:
            df_obs_loc_cut = df_obs_loc[["S_in", "T_in", error]]
            # pivot this table
            pivot_df_obs_loc_cut = df_obs_loc_cut.pivot("S_in", "T_in", error)
            # plot heatmap
            plot(pivot_df_obs_loc_cut, error)


if __name__ == "__main__":
    import pandas as pd
    results = pd.read_csv(
        "/Users/houben/PhD/modelling/20190304_spectral_analysis_homogeneous/models/fitting_results/results.csv"
    )
    path_to_results = "/Users/houben/PhD/modelling/20190304_spectral_analysis_homogeneous/models/fitting_results"
    plot_errors_vs_loc(results, path_to_results)
    plot_heatmap(results, path_to_results)
